# Force Join Channel Manager Handler\n# Manage force join channels through admin panel with buttons\n\nfrom telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup\nfrom telegram.ext import ContextTypes, ConversationHandler\nfrom telegram.error import TelegramError\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n# Conversation states\nAWAIT_ACTION = 1\nAWAIT_CHANNEL_ID = 2\nAWAIT_CHANNEL_USERNAME = 3\nAWAIT_CHANNEL_TITLE = 4\nAWAIT_CONFIRM_ADD = 5\nAWAIT_DELETE_CHANNEL = 6\n\nclass ForceJoinManager:\n    \"\"\"Manage force join channels through admin panel\"\"\"\n    \n    def __init__(self, db):\n        self.db = db\n    \n    async def show_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Show force join management menu\"\"\"\n        query = update.callback_query\n        await query.answer()\n        \n        # Get current force join channels\n        channels = self.db.get_force_join_channels()\n        \n        text = \"\"\"ðŸšª FORCE JOIN CHANNEL MANAGER\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ“Š Current Force Join Channels: {}\n\n{}â”€ What would you like to do?\n        \"\"\".format(\n            len(channels),\n            \"\\n\".join([f\"âœ… @{ch['username']} (ID: {ch['channel_id']})\" for ch in channels]) if channels else \"ðŸ“­ No channels added yet\\n\"\n        )\n        \n        keyboard = [\n            [InlineKeyboardButton(\"âž• Add Channel\", callback_data=\"fj_add_channel\")],\n            [InlineKeyboardButton(\"âŒ Remove Channel\", callback_data=\"fj_remove_channel\")],\n            [InlineKeyboardButton(\"ðŸ”„ Refresh List\", callback_data=\"fj_refresh\")],\n            [InlineKeyboardButton(\"ðŸ”™ Back to Admin\", callback_data=\"admin_dashboard\")]\n        ]\n        \n        reply_markup = InlineKeyboardMarkup(keyboard)\n        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n        return AWAIT_ACTION\n    \n    async def add_channel_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Start adding a new force join channel\"\"\"\n        query = update.callback_query\n        await query.answer()\n        \n        text = \"\"\"âž• ADD NEW FORCE JOIN CHANNEL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ“ Step 1/3: Send Channel ID\n\nðŸ’¡ How to get channel ID:\n1. Forward a message from the channel to @userinfobot\n2. Bot will show you the channel ID (negative number like -1001234567890)\n3. Copy and send that ID\n\nâš ï¸ Important:\n- Channel must be public\n- Bot must be admin in the channel\n- You'll be asked to verify bot admin status\n        \"\"\"\n        \n        keyboard = [\n            [InlineKeyboardButton(\"âŒ Cancel\", callback_data=\"fj_menu\")]\n        ]\n        reply_markup = InlineKeyboardMarkup(keyboard)\n        \n        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n        context.user_data['fj_step'] = 1\n        return AWAIT_CHANNEL_ID\n    \n    async def get_channel_id(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Get channel ID from user\"\"\"\n        try:\n            channel_id = int(update.message.text.strip())\n        except ValueError:\n            await update.message.reply_text(\n                \"âŒ Invalid channel ID!\\n\\n\"\n                \"Channel ID must be a number (like -1001234567890)\\n\\n\"\n                \"Try again:\"\n            )\n            return AWAIT_CHANNEL_ID\n        \n        # Validate channel ID format\n        if not str(channel_id).startswith('-100'):\n            await update.message.reply_text(\n                \"âš ï¸ Channel ID seems incorrect.\\n\\n\"\n                \"Valid channel ID should start with -100 (like -1001234567890)\\n\\n\"\n                \"Try again:\"\n            )\n            return AWAIT_CHANNEL_ID\n        \n        # Check if already added\n        existing = self.db.get_force_join_channel(channel_id)\n        if existing:\n            await update.message.reply_text(\n                \"âœ… This channel is already in force join list!\\n\\n\"\n                \"Use 'Remove Channel' if you want to remove it.\"\n            )\n            return ConversationHandler.END\n        \n        context.user_data['fj_channel_id'] = channel_id\n        \n        text = \"\"\"ðŸ“ Step 2/3: Send Channel Username\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ’¡ Channel username format:\n- Without @: coursepro911\n- Or with @: @coursepro911\n- Both formats work!\n\nâš ï¸ Important:\n- Must be a PUBLIC channel\n- Anyone must be able to join by username\n- Private channels don't work\n\nSend channel username:\n        \"\"\"\n        \n        keyboard = [\n            [InlineKeyboardButton(\"âŒ Cancel\", callback_data=\"fj_menu\")]\n        ]\n        reply_markup = InlineKeyboardMarkup(keyboard)\n        \n        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n        return AWAIT_CHANNEL_USERNAME\n    \n    async def get_channel_username(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Get channel username from user\"\"\"\n        username = update.message.text.strip().replace('@', '').lower()\n        \n        # Validate username\n        if not username or len(username) < 3:\n            await update.message.reply_text(\n                \"âŒ Invalid username!\\n\\n\"\n                \"Channel username must be at least 3 characters.\\n\\n\"\n                \"Try again:\"\n            )\n            return AWAIT_CHANNEL_USERNAME\n        \n        if not username.isalnum() or '-' in username and not all(c.isalnum() or c == '_' for c in username):\n            await update.message.reply_text(\n                \"âŒ Invalid username format!\\n\\n\"\n                \"Username can only have letters, numbers, and underscores.\\n\\n\"\n                \"Try again:\"\n            )\n            return AWAIT_CHANNEL_USERNAME\n        \n        context.user_data['fj_username'] = username\n        \n        text = \"\"\"ðŸ“ Step 3/3: Send Channel Title\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ’¡ Examples:\n- \"Cybersecurity Mastery Course\"\n- \"Course Updates & Announcements\"\n- \"Premium Content Channel\"\n\nSend a short, descriptive title for this channel:\n        \"\"\"\n        \n        keyboard = [\n            [InlineKeyboardButton(\"âŒ Cancel\", callback_data=\"fj_menu\")]\n        ]\n        reply_markup = InlineKeyboardMarkup(keyboard)\n        \n        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n        return AWAIT_CHANNEL_TITLE\n    \n    async def get_channel_title(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Get channel title and show confirmation\"\"\"\n        title = update.message.text.strip()\n        \n        if not title or len(title) < 3:\n            await update.message.reply_text(\n                \"âŒ Title too short!\\n\\n\"\n                \"Please provide a descriptive title (at least 3 characters).\\n\\n\"\n                \"Try again:\"\n            )\n            return AWAIT_CHANNEL_TITLE\n        \n        if len(title) > 100:\n            await update.message.reply_text(\n                \"âŒ Title too long!\\n\\n\"\n                \"Please keep it under 100 characters.\\n\\n\"\n                \"Try again:\"\n            )\n            return AWAIT_CHANNEL_TITLE\n        \n        context.user_data['fj_title'] = title\n        \n        # Show confirmation\n        channel_id = context.user_data['fj_channel_id']\n        username = context.user_data['fj_username']\n        \n        text = \"\"\"âœ… VERIFY CHANNEL DETAILS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ“‹ Channel Information:\n\nðŸ†” Channel ID: `{}`\nðŸ‘¤ Username: `@{}`\nðŸ“Œ Title: `{}`\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâš ï¸ IMPORTANT - Bot Admin Requirements:\n\nBefore confirming, make sure:\nâœ… Bot is admin in the channel\nâœ… Bot has permission to delete messages\nâœ… Channel is PUBLIC (not private)\nâœ… Username is correct\n\nIf bot isn't admin yet:\n1. Add @{}_bot as admin to the channel\n2. Give it all permissions\n3. Then click âœ… Confirm\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n        \"\"\".format(channel_id, username, title, \"coursepro911\" )  # Use your bot username\n        \n        keyboard = [\n            [InlineKeyboardButton(\"âœ… Confirm & Add\", callback_data=\"fj_confirm_add\")],\n            [InlineKeyboardButton(\"âŒ Cancel\", callback_data=\"fj_menu\")]\n        ]\n        reply_markup = InlineKeyboardMarkup(keyboard)\n        \n        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n        return AWAIT_CONFIRM_ADD\n    \n    async def confirm_add_channel(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Confirm and add the force join channel to database\"\"\"\n        query = update.callback_query\n        await query.answer()\n        \n        channel_id = context.user_data.get('fj_channel_id')\n        username = context.user_data.get('fj_username')\n        title = context.user_data.get('fj_title')\n        \n        if not all([channel_id, username, title]):\n            await query.edit_message_text(\n                \"âŒ Error: Missing data. Please start again.\\n\\n\"\n                \"Click 'Force Join Manager' to retry.\"\n            )\n            return ConversationHandler.END\n        \n        try:\n            # Add to database\n            self.db.add_force_join_channel(channel_id, username, title)\n            \n            text = \"\"\"âœ… CHANNEL ADDED SUCCESSFULLY!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸŽ‰ Force join channel added to the system!\n\nðŸ“‹ Details:\nðŸ†” Channel ID: `{}`\nðŸ‘¤ Username: `@{}`\nðŸ“Œ Title: `{}`\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâœ… What happens now:\n\n1. ðŸ”„ All users will see \"Join Required\" message\n2. ðŸ‘¥ They'll need to join @{} to use the bot\n3. âœ… Bot will auto-verify membership\n4. ðŸ“Š You can remove it anytime from admin panel\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n            \"\"\".format(channel_id, username, title, username)\n            \n            keyboard = [\n                [InlineKeyboardButton(\"ðŸšª Back to Manager\", callback_data=\"fj_menu\")],\n                [InlineKeyboardButton(\"ðŸ”™ Back to Admin\", callback_data=\"admin_dashboard\")]\n            ]\n            reply_markup = InlineKeyboardMarkup(keyboard)\n            \n            await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n            \n            # Clear temporary data\n            context.user_data.pop('fj_channel_id', None)\n            context.user_data.pop('fj_username', None)\n            context.user_data.pop('fj_title', None)\n            \n            return ConversationHandler.END\n            \n        except Exception as e:\n            logger.error(f\"Error adding force join channel: {e}\")\n            await query.edit_message_text(\n                f\"âŒ Error adding channel: {str(e)}\\n\\n\"\n                \"Please try again or contact support.\"\n            )\n            return ConversationHandler.END\n    \n    async def remove_channel_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Start removing a force join channel\"\"\"\n        query = update.callback_query\n        await query.answer()\n        \n        # Get current force join channels\n        channels = self.db.get_force_join_channels()\n        \n        if not channels:\n            await query.edit_message_text(\n                \"ðŸ“­ No force join channels to remove!\\n\\n\"\n                \"Use 'Add Channel' to add one first.\",\n                reply_markup=InlineKeyboardMarkup([\n                    [InlineKeyboardButton(\"ðŸ”™ Back\", callback_data=\"fj_menu\")]\n                ])\n            )\n            return ConversationHandler.END\n        \n        text = \"\"\"âŒ REMOVE FORCE JOIN CHANNEL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nðŸ‘‡ Select a channel to remove:\n\n        \"\"\"\n        \n        keyboard = []\n        for ch in channels:\n            keyboard.append([\n                InlineKeyboardButton(\n                    f\"âŒ @{ch['username']} ({ch['title']})\",\n                    callback_data=f\"fj_delete_{ch['channel_id']}\"\n                )\n            ])\n        \n        keyboard.append([InlineKeyboardButton(\"ðŸ”™ Cancel\", callback_data=\"fj_menu\")])\n        reply_markup = InlineKeyboardMarkup(keyboard)\n        \n        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n        return AWAIT_DELETE_CHANNEL\n    \n    async def delete_channel(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Delete a force join channel\"\"\"\n        query = update.callback_query\n        \n        # Extract channel ID from callback data\n        channel_id = int(query.data.split('_')[2])\n        \n        await query.answer()\n        \n        try:\n            channel = self.db.get_force_join_channel(channel_id)\n            \n            if not channel:\n                await query.edit_message_text(\n                    \"âŒ Channel not found!\\n\\n\"\n                    \"It may have been already removed.\"\n                )\n                return ConversationHandler.END\n            \n            # Delete from database\n            self.db.remove_force_join_channel(channel_id)\n            \n            text = \"\"\"âœ… CHANNEL REMOVED!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâœ… Force join channel has been removed!\n\nðŸ“‹ Removed Channel:\nðŸ‘¤ @{}\nðŸ“Œ {}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâœ… What happens now:\n\n1. Users will no longer see \"Join Required\" message\n2. They can use the bot normally\n3. No verification needed anymore\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n            \"\"\".format(channel['username'], channel['title'])\n            \n            keyboard = [\n                [InlineKeyboardButton(\"ðŸšª Back to Manager\", callback_data=\"fj_menu\")],\n                [InlineKeyboardButton(\"ðŸ”™ Back to Admin\", callback_data=\"admin_dashboard\")]\n            ]\n            reply_markup = InlineKeyboardMarkup(keyboard)\n            \n            await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='Markdown')\n            return ConversationHandler.END\n            \n        except Exception as e:\n            logger.error(f\"Error removing force join channel: {e}\")\n            await query.edit_message_text(\n                f\"âŒ Error removing channel: {str(e)}\\n\\n\"\n                \"Please try again or contact support.\"\n            )\n            return ConversationHandler.END\n    \n    async def refresh_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Refresh the force join channels list\"\"\"\n        return await self.show_menu(update, context)\n    \n    async def cancel(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:\n        \"\"\"Cancel operation\"\"\"\n        if update.callback_query:\n            query = update.callback_query\n            await query.answer()\n        \n        return ConversationHandler.END\n"